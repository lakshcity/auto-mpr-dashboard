# =========================
# Path setup (MUST be first)
# =========================
import sys
import os

ROOT_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
if ROOT_DIR not in sys.path:
    sys.path.insert(0, ROOT_DIR)

from services.user_insights import (
    get_user_or_case_insights,
    get_pending_cases,
    get_overdue_cases,
    get_critical_cases
)

# =========================
# Imports
# =========================
import streamlit as st
import pickle
import faiss
from sentence_transformers import SentenceTransformer
from services.retriever import find_similar_cases

# =========================
# Streamlit UI Config
# =========================
st.set_page_config(
    page_title="Auto MPR Recommendation",
    layout="wide"
)

st.title("🛠️ Auto MPR Response Recommendation Dashboard")

st.caption(
    "Recommendations are generated by semantically matching new MPR issues "
    "with historical cases using NLP-based similarity search."
)

# =========================
# 🔧 Control Panel
# =========================
st.subheader("🔧 Control Panel")

col1, col2 = st.columns(2)

with col1:
    scale = st.selectbox(
        "Data scale",
        options=["2k", "25k"],
        index=1
    )

with col2:
    query_mode = st.radio(
        "Query type",
        ["General MPR Issue", "User-Specific View"],
        horizontal=True
    )

# =========================
# Load heavy resources
# =========================
@st.cache_resource
def load_resources(scale):
    model = SentenceTransformer("all-MiniLM-L6-v2")
    index = faiss.read_index(f"data/case_index_{scale}.faiss")
    with open(f"data/case_meta_{scale}.pkl", "rb") as f:
        metadata = pickle.load(f)
    return model, index, metadata

model, index, metadata = load_resources(scale)

# =========================
# User Input Section
# =========================
if query_mode == "General MPR Issue":
    query = st.text_area(
        "Enter MPR Issue",
        height=100,
        placeholder="Describe the issue..."
    )
else:
    user_id = st.text_input(
        "Enter User ID or User Name",
        placeholder="e.g. john.doe"
    )

run_clicked = st.button("Run")

# =========================
# Session State Init
# =========================
if "user_summary" not in st.session_state:
    st.session_state.user_summary = None

if "active_owner" not in st.session_state:
    st.session_state.active_owner = None

# =========================
# General MPR Flow
# =========================
if run_clicked and query_mode == "General MPR Issue":
    if not query.strip():
        st.warning("Please enter an MPR issue.")
    else:
        with st.spinner("Searching similar past MPRs..."):
            results = find_similar_cases(
                query=query,
                model=model,
                index=index,
                metadata=metadata
            )

        results = sorted(results, key=lambda x: x.get("confidence", 0), reverse=True)

        st.subheader("🔍 Similar Historical Cases")

        for i, r in enumerate(results, 1):
            confidence = round(r.get("confidence", 0), 2)
            label = "🟢 Best Match" if i == 1 else ""

            with st.expander(f"Case {i} {label} — Match Confidence: {confidence}%"):
                st.json(r)

# =========================
# User / Case Insights (LOAD ONCE)
# =========================
if run_clicked and query_mode == "User-Specific View":
    if not user_id.strip():
        st.warning("Please enter a caseID or full name.")
    else:
        insights = get_user_or_case_insights(user_id)

        if insights["data"] is None:
            st.error("No data found for the given input.")
        else:
            if insights["type"] == "case":
                case = insights["data"]

                st.subheader(f"📄 Case Details — {case['caseid']}")
                st.json(case)

                st.session_state.user_summary = None
                st.session_state.active_owner = None

            else:
                summary = insights["data"]
                st.session_state.user_summary = summary
                st.session_state.active_owner = summary["owner"]

# =========================
# User Summary View (PERSISTENT)
# =========================
if st.session_state.user_summary is not None:
    summary = st.session_state.user_summary
    owner = st.session_state.active_owner

    st.subheader(f"👤 User Summary — {owner}")

    c1, c2, c3, c4 = st.columns(4)
    c1.metric("Total Cases", summary["total_cases"])
    c2.metric("Pending", summary["pending_cases"])
    c3.metric("Overdue (>7d)", summary["overdue_cases"])
    c4.metric("Critical (>21d)", summary["critical_cases"])

    st.markdown("### Status Breakdown")
    st.json(summary["status_breakdown"])

    # =========================
    # Focused Case View (FIXED)
    # =========================
    st.markdown("---")
    st.subheader("📌 Focused Case View")

    case_type = st.radio(
        "Select case category",
        ["Pending", "Overdue", "Critical"],
        horizontal=True
    )

    if case_type == "Pending":
        cases = get_pending_cases(owner)
        badge = "🟡 Pending"
        empty_msg = "No pending cases found for this user."
    elif case_type == "Overdue":
        cases = get_overdue_cases(owner)
        badge = "🟠 Overdue"
        empty_msg = "No overdue cases found for this user."
    else:
        cases = get_critical_cases(owner)
        badge = "🔴 Critical"
        empty_msg = "No critical cases found for this user."

    if not cases:
        st.info(empty_msg)
    else:
        for c in cases:
            with st.expander(
                f"{badge} | Case {c['caseid']} | Aging: {c['aging']} days"
            ):
                st.write(f"**Category:** {c['category']}")
                st.write(f"**Status:** {c['statuscode']}")
                st.write(f"**Reported On:** {c['reportedon']}")
                st.write(f"**Subject:** {c.get('subject','')}")
                st.write(f"**Details:** {c.get('details','')}")
